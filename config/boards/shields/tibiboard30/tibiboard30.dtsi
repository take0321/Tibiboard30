#include <physical_layouts.dtsi>
#include <dt-bindings/zmk/matrix_transform.h>

/* マクロ定義（必須） */
#define RC(r,c) <((((r) << 5) | (c)))>

/ {
    chosen {
        zmk,physical-layout = &layout;
        zmk,kscan = &kscan;
    };

    /* キースキャン設定（片手分：3行 x 5列） */
    kscan: kscan {
        compatible = "zmk,kscan-gpio-matrix";
        diode-direction = "col2row";
        wakeup-source;

        /* 行（Row）: D7, D8, D9 */
        row-gpios
            = <&xiao_d 7 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            , <&xiao_d 8 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            , <&xiao_d 9 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>
            ;
        
        /* 列（Column）: D6, D5, D4, D3, D2 */
        col-gpios
            = <&xiao_d 6 GPIO_ACTIVE_HIGH>
            , <&xiao_d 5 GPIO_ACTIVE_HIGH>
            , <&xiao_d 4 GPIO_ACTIVE_HIGH>
            , <&xiao_d 3 GPIO_ACTIVE_HIGH>
            , <&xiao_d 2 GPIO_ACTIVE_HIGH>
            ;
    };

    /* マトリックス変換（全体：3行 x 10列） */
    transform: matrix_transform {
        compatible = "zmk,matrix-transform";
        rows = <3>;
        columns = <10>; 

        /* 左手(0-4) と 右手(5-9) の論理マップ */
        map = <
            RC(0, 0) RC(0, 1) RC(0, 2) RC(0, 3) RC(0, 4) RC(0, 5) RC(0, 6) RC(0, 7) RC(0, 8) RC(0, 9)
            RC(1, 0) RC(1, 1) RC(1, 2) RC(1, 3) RC(1, 4) RC(1, 5) RC(1, 6) RC(1, 7) RC(1, 8) RC(1, 9)
            RC(2, 0) RC(2, 1) RC(2, 2) RC(2, 3) RC(2, 4) RC(2, 5) RC(2, 6) RC(2, 7) RC(2, 8) RC(2, 9)
        >;
    };

    /* ZMK Studio用 物理レイアウト定義 */
    layout: layout {
        compatible = "zmk,physical-layout";
        display-name = "tibiboard30";
        transform = <&transform>;
        
        keys =
            /* --- 左手側 (X: 0 - 400) --- */
            <&key_physical_attrs 100 100    0    0>,
            <&key_physical_attrs 100 100  100    0>,
            <&key_physical_attrs 100 100  200    0>,
            <&key_physical_attrs 100 100  300    0>,
            <&key_physical_attrs 100 100  400    0>,
            
            /* --- 右手側 (X: 600 - 1000) --- */
            <&key_physical_attrs 100 100  600    0>,
            <&key_physical_attrs 100 100  700    0>,
            <&key_physical_attrs 100 100  800    0>,
            <&key_physical_attrs 100 100  900    0>,
            <&key_physical_attrs 100 100 1000    0>,

            /* --- 2行目 --- */
            <&key_physical_attrs 100 100    0  100>,
            <&key_physical_attrs 100 100  100  100>,
            <&key_physical_attrs 100 100  200  100>,
            <&key_physical_attrs 100 100  300  100>,
            <&key_physical_attrs 100 100  400  100>,

            <&key_physical_attrs 100 100  600  100>,
            <&key_physical_attrs 100 100  700  100>,
            <&key_physical_attrs 100 100  800  100>,
            <&key_physical_attrs 100 100  900  100>,
            <&key_physical_attrs 100 100 1000  100>,

            /* --- 3行目 --- */
            <&key_physical_attrs 100 100    0  200>,
            <&key_physical_attrs 100 100  100  200>,
            <&key_physical_attrs 100 100  200  200>,
            <&key_physical_attrs 100 100  300  200>,
            <&key_physical_attrs 100 100  400  200>,

            <&key_physical_attrs 100 100  600  200>,
            <&key_physical_attrs 100 100  700  200>,
            <&key_physical_attrs 100 100  800  200>,
            <&key_physical_attrs 100 100  900  200>,
            <&key_physical_attrs 100 100 1000  200>;
    };
};
